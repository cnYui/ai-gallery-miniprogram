# 文生图功能部署说明

## 概述

本项目已集成阿里云通义万相文生图API，实现了以下功能：
- 创建文生图任务
- 查询任务结果
- 重新生成图片

## 部署步骤

### 1. 云函数部署

#### 1.1 上传云函数
在微信开发者工具中：
1. 右键点击 `cloudfunctions/text2image` 文件夹
2. 选择「上传并部署：云端安装依赖（不上传node_modules）」
3. 等待部署完成

#### 1.2 配置环境变量（可选）
为了安全起见，建议将API Key配置为环境变量：
1. 在微信开发者工具的云开发控制台中
2. 进入「云函数」→「环境变量」
3. 添加环境变量：
   - 变量名：`DASHSCOPE_API_KEY`
   - 变量值：`sk-3fe484a165de4b67965fde33e733a64c`

如果配置了环境变量，需要修改云函数代码：
```javascript
// 将这行
const DASHSCOPE_API_KEY = 'sk-3fe484a165de4b67965fde33e733a64c';
// 改为
const DASHSCOPE_API_KEY = process.env.DASHSCOPE_API_KEY;
```

### 2. 小程序配置

#### 2.1 域名白名单配置
在微信公众平台的小程序管理后台：
1. 进入「开发」→「开发管理」→「开发设置」
2. 在「服务器域名」中添加：
   - request合法域名：`https://dashscope.aliyuncs.com`

#### 2.2 云开发环境配置
确保 `app.ts` 中的云开发环境ID正确：
```typescript
wx.cloud.init({
  env: 'cloud1-6g4qsd2kcddd1be0', // 替换为你的云开发环境ID
  traceUser: true,
})
```

## 功能说明

### 创作流程
1. 用户在创作页面输入提示词
2. 点击「生成图片」按钮
3. 调用云函数创建文生图任务
4. 跳转到结果页面
5. 自动轮询查询任务状态
6. 任务完成后显示生成的图片

### 云函数接口

#### 创建任务
```javascript
wx.cloud.callFunction({
  name: 'text2image',
  data: {
    name: 'createTask',
    data: {
      prompt: '提示词',
      negative_prompt: '反向提示词（可选）',
      size: '1024*1024',
      n: 1
    }
  }
})
```

#### 查询结果
```javascript
wx.cloud.callFunction({
  name: 'text2image',
  data: {
    name: 'getResult',
    data: {
      task_id: '任务ID'
    }
  }
})
```

### 任务状态说明
- `PENDING`: 任务排队中
- `RUNNING`: 任务处理中
- `SUCCEEDED`: 任务执行成功
- `FAILED`: 任务执行失败
- `CANCELED`: 任务取消成功
- `UNKNOWN`: 任务不存在或状态未知

## 注意事项

1. **API配额限制**：阿里云API有调用次数限制，请注意控制使用量
2. **图片有效期**：生成的图片URL有效期为24小时
3. **网络超时**：文生图任务通常需要1-3分钟，请耐心等待
4. **错误处理**：已实现完善的错误处理和重试机制
5. **轮询频率**：当前设置为每3秒查询一次任务状态，可根据需要调整

## 故障排除

### 常见问题

1. **云函数调用失败**
   - 检查云函数是否正确部署
   - 确认云开发环境ID配置正确
   - 查看云函数日志排查错误

2. **API调用失败**
   - 检查API Key是否正确
   - 确认域名白名单配置
   - 查看网络连接状态

3. **任务一直处于PENDING状态**
   - 阿里云服务可能繁忙，请耐心等待
   - 可以尝试重新生成

4. **图片无法显示**
   - 检查图片URL是否有效
   - 确认图片域名在小程序白名单中

### 调试方法

1. 查看云函数日志：
   - 在微信开发者工具的云开发控制台
   - 进入「云函数」→选择函数→「日志」

2. 查看小程序控制台：
   - 在开发者工具的调试器中查看console输出
   - 检查网络请求状态

## 扩展功能

可以考虑添加的功能：
- 图片保存到云存储
- 生成历史记录
- 批量生成
- 图片编辑功能
- 分享功能